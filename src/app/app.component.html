<ion-app>
  <ion-content>
    <ion-grid *ngIf="user$ | async as user; else authTemplate" fixed>
      
      <ion-row class="ion-padding ion-align-items-center">
        <ion-col>
          <h1>
            Hexa Wallets Tracker
          </h1>
          <p>
            Welcome, {{ user.email }}
          </p>
          <p>

          </p>
        </ion-col>
        <ion-col size="auto">
          <ion-button (click)="backup()" fill="clear"> 
            <ion-icon name="download-outline"></ion-icon>
          </ion-button>
          <ion-button (click)="logout()"> Logout </ion-button>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col size="6">
          <ion-card>
            <ion-card-content>
              <ion-card-title class="ion-padding-start ion-padding-top">
                <h2>
                  Overview
                </h2>
              </ion-card-title>
              <ion-grid>
                <ion-row>
                  <ion-col size="12">
                    <ion-list lines="none" class="resume">
                      <ion-item>
                        <ion-label> Total </ion-label>
                        <ion-label slot="end">
                          {{
                            totalWalletWorth
                              | currency : "USD" : "symbol" : "1.2-2"
                          }}
                        </ion-label>
                      </ion-item>
                      <ion-item>
                        <ion-label> Stable </ion-label>
                        <ion-label slot="end">
                          {{
                            totalStaleWorth
                              | currency : "USD" : "symbol" : "1.2-2"
                          }}
                        </ion-label>
                      </ion-item>
                      <ion-item>
                        <ion-label> Volatile </ion-label>
                        <ion-label slot="end">
                          {{
                            totalWalletWorth - totalStaleWorth
                              | currency : "USD" : "symbol" : "1.2-2"
                          }}
                        </ion-label>
                      </ion-item>
                      <ion-item>
                        <ion-label> Initial bag </ion-label>
                        <ion-label slot="end">
                          {{
                            totalWalletWorth - totalPL
                              | currency : "USD" : "symbol" : "1.2-2"
                          }}
                        </ion-label>
                      </ion-item>
                      <ion-item>
                        <ion-label> Total P/L </ion-label>
                        <ion-label slot="end" class="ion-text-end">
                          {{ totalPL | currency : "USD" : "symbol" : "1.2-2"
                          }}<br />
                          <small>
                            {{
                              (totalPL
                                | calculPercent : totalWalletWorth - totalPL
                                | number : "1.2-2")||0
                            }}%
                          </small>
                        </ion-label>
                      </ion-item>
                    </ion-list>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="6">
          <ion-card>
            <ion-card-content>
              <ion-card-title class="ion-padding-start ion-padding-top">
                <h2>Add Transaction</h2>
              </ion-card-title>
              <form [formGroup]="txForm">
                <ion-grid>
                  <ion-row>
                    <ion-col size="6">
                      <ion-list>
                        <ion-item (click)="openSelectTicker = true">
                          <ion-label position="stacked">Ticker</ion-label>
                          <ion-input
                            [disabled]="true"
                            formControlName="tickerId"
                          ></ion-input>
                        </ion-item>
                        <ion-item (click)="openSelectWallet = true">
                          <ion-label position="stacked">Wallet</ion-label>
                          <ion-input
                            [disabled]="true"
                            formControlName="walletId"
                          ></ion-input>
                        </ion-item>
                        <ion-item (click)="openSelectNetwork = true">
                          <ion-label position="stacked">Network</ion-label>
                          <ion-input [disabled]="true" formControlName="networkId"></ion-input>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked">Notes</ion-label>
                          <ion-textarea formControlName="notes"></ion-textarea>
                        </ion-item>
                      </ion-list>
                    </ion-col>
                    <ion-col size="6">
                      <ion-list>
                        <ion-item>
                          <ion-label position="stacked">Quantity</ion-label>
                          <ion-input
                            type="number"
                            formControlName="quantity"
                          ></ion-input>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked">Price</ion-label>
                          <ion-input
                            type="number"
                            formControlName="price"
                          ></ion-input>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked">Fees</ion-label>
                          <ion-input formControlName="fees"></ion-input>
                        </ion-item>
                        <ion-item>
                          <ion-label position="stacked"
                            >DeFi Protocol ID</ion-label
                          >
                          <ion-input
                            formControlName="defiProtocolId"
                          ></ion-input>
                        </ion-item>
                      </ion-list>
                    </ion-col>
                  </ion-row>
                </ion-grid>
                <ion-button
                  expand="full"
                  type="submit"
                  [disabled]="!txForm.valid"
                  (click)="addTx()"
                  >Submit</ion-button
                >
              </form>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>

      <ion-row class="ion-padding-horizontal ion-margin-top ion-padding-top">
        <ion-col size="2"> Ticker </ion-col>
        <ion-col size="1" class="ion-text-end"> Units </ion-col>
        <ion-col size="2" class="ion-text-end"> 24h Change </ion-col>
        <ion-col size="2" class="ion-text-end"> Total </ion-col>
        <ion-col size="2" class="ion-text-end"> Average Cost </ion-col>
        <ion-col size="2" class="ion-text-end"> P/L </ion-col>
        <ion-col size="1" class="ion-text-end"> Wallet % </ion-col>
      </ion-row>

      <ion-row>
        <ion-col size="12">
          <ion-card>
            <ion-card-content>
              <ion-list>
                <ion-item
                  *ngFor="let tx of txs$ | async"
                  (click)="openDetails(tx.tickerId)"
                >
                  <ion-grid>
                    <ion-row class="ion-align-items-center">
                      <ion-col size="2">
                        <ion-label>
                          <h2>{{ tx.tickerId }}</h2>
                          <p>
                            {{
                              tx.price | currency : "USD" : "symbol" : "1.2-2"
                            }}
                          </p>
                        </ion-label>
                      </ion-col>
                      <ion-col size="1" class="ion-text-end">
                        {{ tx.units | number : "1.2-2" }}
                      </ion-col>
                      <ion-col size="2" class="ion-text-end">
                        <ion-text
                          [color]="tx['24h_change'] >= 0 ? 'success' : 'danger'"
                        >
                          {{ tx["24h_change"] | number : "1.2-2" }}%
                        </ion-text>
                      </ion-col>
                      <ion-col size="2" class="ion-text-end">
                        <b>
                          {{
                            tx
                              | totalPosition
                              | currency : "USD" : "symbol" : "1.2-2"
                          }}
                        </b>
                      </ion-col>
                      <ion-col size="2" class="ion-text-end">
                        {{
                          tx.averageCost | currency : "USD" : "symbol" : "1.2-2"
                        }}
                      </ion-col>
                      <ion-col size="2" class="ion-text-end">
                        <ion-text
                          [color]="
                            (tx.plDollars || 0) >= 0 ? 'success' : 'danger'
                          "
                        >
                          {{
                            tx.plDollars
                              | currency : "USD" : "symbol" : "1.2-2"
                          }}<br />
                          <small> {{ tx.plPercentage }}% </small>
                        </ion-text>
                      </ion-col>
                      <ion-col size="1" class="ion-text-end">
                        <b>
                          {{
                            tx
                              | totalPercent : totalWalletWorth
                              | number : "1.2-2"
                          }}%
                        </b>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </ion-item>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>

    </ion-grid>

    <ng-template #authTemplate fixed>
      <ion-grid class="ion-text-center">
        <ion-row>
          <ion-col>
            <ion-text>
              <h1>Welcome</h1>
              <p>Please login to continue</p>
            </ion-text>
            <ion-button (click)="login()"> Login </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ng-template>
  </ion-content>

  <ion-modal [isOpen]="openSelectTicker">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Search Ticker</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="openSelectTicker = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-searchbar
          debounce="500"
          (ionInput)="searchTicker($event.detail.value || '')"
        ></ion-searchbar>
        <ion-list>
          <ion-item
            *ngFor="let ticker of filteredTickers"
            (click)="selectTicker(ticker.symbol)"
          >
            <ion-label>
              <h2>{{ ticker.symbol }}</h2>
              <p>{{ ticker.name }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="openSelectWallet">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Select Wallet</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="openSelectWallet = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-list>
          <ion-item
            *ngFor="let wallet of userWallets$ | async"
            (click)="selectWallet(wallet.id)"
          >
            <ion-label>
              <h2>{{ wallet.id }}</h2>
              <p>{{ wallet.name }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="openSelectNetwork">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Select Network</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="openSelectNetwork = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-searchbar
          debounce="500"
          (ionInput)="searchNetwork($event.detail.value || '')"
        ></ion-searchbar>
        <ion-list>
          <ion-item
            *ngFor="let network of networks"
            (click)="selectNetwork(network.id)"
          >
            <ion-label>
              <h2>{{ network.id }}</h2>
              <p>{{ network.name }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-app>
