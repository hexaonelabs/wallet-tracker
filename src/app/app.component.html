<ion-app>
  <ion-content>
    <ng-container *ngIf="user$ | async as user; else authTemplate">
      <ion-grid fixed>
        <ion-row class="ion-padding ion-align-items-center">
          <ion-col>
            <h1>TXS Tracker</h1>
            <p>
              Track your crypto transactions
            </p>
            <p></p>
          </ion-col>
          <ion-col size="auto">
            <ion-button (click)="openAddTx = true">
              <ion-icon name="add-outline"></ion-icon>
            </ion-button>
            <ion-button [disabled]="refresh$|async" (click)="refresh$.next(true)">
              <ion-icon name="refresh-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="backup()">
              <ion-icon name="download-outline"></ion-icon>
            </ion-button>
            <ion-button (click)="logout()"> Logout </ion-button>
          </ion-col>
        </ion-row>
  
        <ng-container *ngIf="userWallets$|async as userWallets; else noUserWallets">
          <ng-container *ngIf="assetPositions$ | async as assetPositions ;else noAssetPositions">
            <ion-row>
              <ion-col size="12" size-md="6">
                <h2 class="ion-margin-start cardTitle">Overview</h2>
                <ion-card>
                  <ion-card-content>
                    <ion-grid>
                      <ion-row>
                        <ion-col size="12">
                          <ion-list lines="none" class="resume">
                            <ion-item>
                              <ion-label> Total </ion-label>
                              <ion-label slot="end" class="ion-text-end">
                                {{
                                  totalWalletWorth
                                    | currency : "USD" : "symbol" : "1.2-2"
                                }}
                              </ion-label>
                            </ion-item>
                            <ion-item>
                              <ion-label> Stable </ion-label>
                              <ion-label slot="end" class="ion-text-end">
                                {{
                                  totalStaleWorth
                                    | currency : "USD" : "symbol" : "1.2-2"
                                }}<br />
                                <small>
                                  {{
                                    (totalStaleWorth
                                      | calculPercent : totalWalletWorth
                                      | number : "1.2-2") || 0
                                  }}%
                                </small>
                              </ion-label>
                            </ion-item>
                            <ion-item>
                              <ion-label> Volatile </ion-label>
                              <ion-label slot="end" class="ion-text-end">
                                {{
                                  totalWalletWorth - totalStaleWorth
                                    | currency : "USD" : "symbol" : "1.2-2"
                                }}<br />
                                <small>
                                  {{
                                    (totalWalletWorth - totalStaleWorth
                                      | calculPercent : totalWalletWorth
                                      | number : "1.2-2") || 0
                                  }}%
                                </small>
                              </ion-label>
                            </ion-item>
                            <ion-item>
                              <ion-label> Initial bag </ion-label>
                              <ion-label slot="end" class="ion-text-end">
                                {{
                                  totalWalletWorth - totalPL
                                    | currency : "USD" : "symbol" : "1.2-2"
                                }}
                              </ion-label>
                            </ion-item>
                            <ion-item>
                              <ion-label> Total P/L </ion-label>
                              <ion-label slot="end" class="ion-text-end">
                                {{ totalPL | currency : "USD" : "symbol" : "1.2-2"
                                }}<br />
                                <small>
                                  {{
                                    (totalPL
                                      | calculPercent : totalWalletWorth - totalPL
                                      | number : "1.2-2") || 0
                                  }}%
                                </small>
                              </ion-label>
                            </ion-item>
                          </ion-list>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </ion-card-content>
                </ion-card>
              </ion-col>

              <ion-col size="12" size-md="6">
                <h2 class="ion-margin-start cardTitle">Stats</h2>
                <ion-card>
                  <ion-card-content>
                    <ion-grid>
                      <ion-row>
                        <ion-col size="12">
                          <app-chart2
                            [data]="chart2Data$|async" />
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </ion-card-content>
                </ion-card>
              </ion-col>
      
              <!-- <ion-col size="12" size-md="6">
                <h2 class="ion-margin-start cardTitle">Add Transaction</h2>
                <ion-card>
                  <ion-card-content>
                    <form [formGroup]="txForm">
                      <ion-grid>
                        <ion-row>
                          <ion-col size="6">
                            <ion-list>
                              <ion-item (click)="openSelectTicker = true">
                                <ion-label position="stacked">Ticker</ion-label>
                                <ion-input
                                  [disabled]="true"
                                  formControlName="tickerId"
                                ></ion-input>
                              </ion-item>
                              <ion-item (click)="openSelectWallet = true">
                                <ion-label position="stacked">Wallet</ion-label>
                                <ion-input
                                  [disabled]="true"
                                  formControlName="walletId"
                                ></ion-input>
                              </ion-item>
                              <ion-item (click)="openSelectNetwork = true">
                                <ion-label position="stacked">Network</ion-label>
                                <ion-input
                                  [disabled]="true"
                                  formControlName="networkId"
                                ></ion-input>
                              </ion-item>
                              <ion-item>
                                <ion-label position="stacked">Notes</ion-label>
                                <ion-textarea formControlName="notes"></ion-textarea>
                              </ion-item>
                            </ion-list>
                          </ion-col>
                          <ion-col size="6">
                            <ion-list>
                              <ion-item>
                                <ion-label position="stacked">Quantity</ion-label>
                                <ion-input
                                  type="number"
                                  formControlName="quantity"
                                ></ion-input>
                              </ion-item>
                              <ion-item>
                                <ion-label position="stacked">Price</ion-label>
                                <ion-input
                                  type="number"
                                  formControlName="price"
                                ></ion-input>
                              </ion-item>
                              <ion-item>
                                <ion-label position="stacked">Fees</ion-label>
                                <ion-input formControlName="fees"></ion-input>
                              </ion-item>
                              <ion-item (click)="openSelectDefi = true">
                                <ion-label position="stacked"
                                  >DeFi Protocol ID</ion-label
                                >
                                <ion-input
                                  formControlName="defiProtocolId"
                                ></ion-input>
                              </ion-item>
                            </ion-list>
                          </ion-col>
                        </ion-row>
                      </ion-grid>
                      <ion-button
                        expand="full"
                        type="submit"
                        [disabled]="!txForm.valid"
                        (click)="addTx($any($event.target))"
                        >Submit
                        {{
                          ((txForm.value.price ?? 0) * (txForm.value.quantity ?? 0) +
                            (txForm.value.fees ?? 0))
                            | currency : "USD" : "symbol" : "1.2-2"
                        }}</ion-button
                      >
                    </form>
                  </ion-card-content>
                </ion-card>
              </ion-col> -->
            </ion-row>
      
            <ion-row
              class="header-table ion-margin-top ion-padding-top ion-align-items-center ion-hide-md-down"
            >
              <ion-col size="2"> Ticker </ion-col>
              <ion-col size="2" class="ion-text-end"> 24h Change </ion-col>
              <ion-col size="2" class="ion-text-end">
                Total<br /><small>Units</small>
              </ion-col>
              <ion-col size="2" class="ion-text-end"> Initial Invest<br/><small>Average Cost </small></ion-col>
              <ion-col size="2" class="ion-text-end"> P/L </ion-col>
              <ion-col size="2" class="ion-text-end"> Wallet % </ion-col>
            </ion-row>
      
            <ion-row
              class="header-table ion-margin-top ion-padding-top ion-align-items-center ion-hide-md-up"
            >
              <ion-col size="6"> 
                Ticker<br/>
                <small>
                  Total
                </small>
              </ion-col>
              <ion-col size="6" class="ion-text-end"> 
                Wallet %<br/>
                <small>P/L</small>
              </ion-col>
            </ion-row>
      
            <ion-row>
              <ion-col size="12">
                <ion-card>
                  <ion-card-content>
                    <ion-list>
                      <ion-item
                        *ngFor="let asset of assetPositions"
                        button
                        [detail]="false"
                        (click)="openDetails(asset)"
                      >
                        <ion-avatar slot="start">
                          <img
                            [src]="asset.logo"
                            title="{{ asset.tickerId }}"
                            alt="{{ asset.tickerId }}"
                          />
                        </ion-avatar>
                        <ion-grid class="ion-hide-md-down">
                          <ion-row class="ion-align-items-center">
                            <ion-col size="2">
                              <ion-label>
                                <h2>{{ asset.tickerId }}</h2>
                                <p>
                                  {{
                                    asset.price | currency : "USD" : "symbol" : "1.2-2"
                                  }}
                                </p>
                              </ion-label>
                            </ion-col>
                            <ion-col size="2" class="ion-text-end">
                              <ion-text
                                [color]="asset['24h_change'] >= 0 ? 'success' : 'danger'"
                              >
                                {{ asset["24h_change"] | number : "1.2-2" }}%
                              </ion-text>
                            </ion-col>
                            <ion-col size="2" class="ion-text-end">
                              <b>
                                {{
                                  asset
                                    | totalPosition
                                    | currency : "USD" : "symbol" : "1.2-2"
                                }} </b
                              ><br />
                              <small> {{ asset.units | number : "1.2-2" }} units</small>
                            </ion-col>
                            <ion-col size="2" class="ion-text-end">
                              {{ asset | initialInvest | currency : "USD" : "symbol" : "1.2-2"}}
                              <br />
                              <small>
                                {{
                                  asset.averageCost | currency : "USD" : "symbol" : "1.2-2"
                                }}
                              </small>
                            </ion-col>
                            <ion-col size="2" class="ion-text-end">
                              <ion-text
                                [color]="
                                  (asset.plDollars || 0) >= 0 ? 'success' : 'danger'
                                "
                              >
                                {{
                                  asset.plDollars
                                    | currency : "USD" : "symbol" : "1.2-2"
                                }}<br />
                                <small>
                                  {{ asset.plPercentage | number : "1.2-2" || 0 }}%
                                </small>
                              </ion-text>
                            </ion-col>
                            <ion-col size="2" class="ion-text-end">
                              <b>
                                {{
                                  asset
                                    | totalPercent : totalWalletWorth
                                    | number : "1.2-2"
                                }}%
                              </b>
                            </ion-col>
                          </ion-row>
                        </ion-grid>
      
                        <ion-grid class="ion-hide-md-up">
                          <ion-row class="ion-align-items-center">
                            <ion-col>
                              <ion-label>
                                <h2><b>{{ asset.tickerId }}</b></h2>
                                <p>
                                  {{
                                    asset.price | currency : "USD" : "symbol" : "1.2-2"
                                  }}
                                </p>
                                <p>
                                  <b>
                                    {{
                                      asset
                                        | totalPosition
                                        | currency : "USD" : "symbol" : "1.2-2"
                                    }} </b
                                  >
                                </p>
                              </ion-label>
                            </ion-col>
                            <ion-col class="ion-text-end">
                              <ion-text>
                                <b>
                                  {{
                                    asset
                                      | totalPercent : totalWalletWorth
                                      | number : "1.2-2"
                                  }}%
                                </b>
                              </ion-text>
                              <ion-text
                                [color]="
                                  (asset.plDollars || 0) >= 0 ? 'success' : 'danger'
                                "
                              >
                                {{
                                  asset.plDollars
                                    | currency : "USD" : "symbol" : "1.2-2"
                                }}<br />
                                <small>
                                  {{ asset.plPercentage | number : "1.2-2" || 0 }}%
                                </small>
                              </ion-text>
                            </ion-col>
                          </ion-row>
                        </ion-grid>
                      </ion-item>
                    </ion-list>
                  </ion-card-content>
                </ion-card>
              </ion-col>
            </ion-row>

          </ng-container>
  
          <ng-template #noAssetPositions>
            <ion-row>
              <ion-col size="12">
                <ion-card>
                  <ion-card-content>
                    <ion-text>
                      <h2>No asset positions</h2>
                      <p>Click on the button below to add a new transaction</p>
                    </ion-text>
                    <ion-button (click)="openAddTx = true">
                      Add Transaction
                    </ion-button>
                  </ion-card-content>
                </ion-card>
              </ion-col>
            </ion-row>
          </ng-template>
        </ng-container>

        <ng-template #noUserWallets>
          <ion-row>
            <ion-col size="12">
              <ion-card>
                <ion-card-content>
                  <ion-text>
                    <h2>No wallets</h2>
                    <p>Click on the button below to add a new wallet</p>
                  </ion-text>
                  <ion-input
                    #walletNameInput
                    class="ion-margin-top"
                    label="Wallet name"
                    label-position="stacked"
                    fill="outline"
                    mode="md"
                    type="text"
                    placeholder="enter a name for your wallet" />
                  <ion-button 
                    class="ion-margin-top"
                    [disabled]="!walletNameInput.value"
                    (click)="createItem({ type: 'wallet', payload: $any(walletNameInput.value) })">
                    Add Wallet
                  </ion-button>
                </ion-card-content>
              </ion-card>
            </ion-col>
          </ion-row>
        </ng-template>

      </ion-grid>
    </ng-container>

    <ng-template #authTemplate>
      <ion-grid class="ion-text-center" fixed>
        <ion-row>
          <ion-col>
            <ion-text>
              <h1>Welcome</h1>
              <p>Please login to continue</p>
            </ion-text>
            <ion-button (click)="login()"> Login </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ng-template>
    
  </ion-content>

  <ion-modal [isOpen]="openSelectTicker">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Search Ticker</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="openSelectTicker = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-searchbar
          debounce="500"
          (ionInput)="searchTicker($event.detail.value || '')"
        ></ion-searchbar>
        <ion-list>
          <ion-item
            *ngFor="let ticker of filteredTickers"
            (click)="selectTicker(ticker.symbol)"
          >
            <ion-label>
              <h2>{{ ticker.symbol }}</h2>
              <p>{{ ticker.name }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="openSelectWallet">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Select Wallet</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="openSelectWallet = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-searchbar
          #searchBar
          debounce="500"
          (ionInput)="searchWallet($event.detail.value || '')"
        ></ion-searchbar>
        <div *ngIf="userWallets$ | async as userWallets">
          <ion-list *ngIf="userWallets.length > 0; else createBtn">
            <ion-item
              *ngFor="let wallet of userWallets"
              (click)="selectWallet(wallet)"
            >
              <ion-label>
                <h2>{{ wallet.name || "no name" }}</h2>
                <p *ngIf="wallet.address">{{ wallet.address }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>
        <ng-template #createBtn>
          <ion-button (click)="createItem({
            type: 'wallet',
            payload: searchBar.value
          })">create wallet</ion-button>
        </ng-template>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="openSelectDefi">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Select Defi</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="openSelectDefi = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-searchbar
          #searchBar
          debounce="500"
          (ionInput)="searchDefi($event.detail.value || '')"
        ></ion-searchbar>
        <div *ngIf="defiProtocols$ | async as defiProtocols">
          <ion-list *ngIf="defiProtocols.length > 0; else createBtn">
            <ion-item
              *ngFor="let defi of defiProtocols"
              (click)="selectDefi(defi)"
            >
              <ion-label>
                <h2>{{ defi.name || "no name" }}</h2>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>
        <ng-template #createBtn>
          <ion-button (click)="createItem({
            type: 'defiProtocol',
            payload: searchBar.value
          })">create defi Protocol</ion-button>
        </ng-template>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal [isOpen]="openSelectNetwork">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Select Network</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="openSelectNetwork = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <ion-searchbar
          debounce="500"
          (ionInput)="searchNetwork($event.detail.value || '')"
        ></ion-searchbar>
        <ion-list>
          <ion-item
            *ngFor="let network of networks"
            (click)="selectNetwork(network)"
          >
            <ion-label>
              <h2>{{ network.id }}</h2>
              <p>{{ network.name }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

  <ion-modal 
    [isOpen]="openAddTx"
    (ionModalDidDismiss)="openAddTx = false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Add transaction</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="openAddTx = false">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content>
        <form [formGroup]="txForm">
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <ion-list>
                  <ion-item (click)="openSelectTicker = true">
                    <ion-label position="stacked">Ticker</ion-label>
                    <ion-input
                      [disabled]="true"
                      formControlName="tickerId"
                    ></ion-input>
                  </ion-item>
                  <ion-item (click)="openSelectWallet = true" formGroupName="wallet">
                    <ion-label position="stacked">Wallet</ion-label>
                    <ion-input
                      [disabled]="true"
                      formControlName="displayName"
                    ></ion-input>
                  </ion-item>
                  <ion-item (click)="openSelectNetwork = true" formGroupName="network">
                    <ion-label position="stacked">Network</ion-label>
                    <ion-input
                      [disabled]="true"
                      formControlName="displayName"
                    ></ion-input>
                  </ion-item>
                  <ion-item>
                    <ion-label position="stacked">Notes</ion-label>
                    <ion-textarea formControlName="notes"></ion-textarea>
                  </ion-item>
                </ion-list>
              </ion-col>
              <ion-col size="6">
                <ion-list>
                  <ion-item>
                    <ion-label position="stacked">Quantity</ion-label>
                    <ion-input
                      type="number"
                      formControlName="quantity"
                    ></ion-input>
                  </ion-item>
                  <ion-item>
                    <ion-label position="stacked">Price</ion-label>
                    <ion-input
                      type="number"
                      formControlName="price"
                    ></ion-input>
                  </ion-item>
                  <ion-item>
                    <ion-label position="stacked">Fees</ion-label>
                    <ion-input formControlName="fees" type="number"></ion-input>
                  </ion-item>
                  <ion-item (click)="openSelectDefi = true" formGroupName="defiProtocol">
                    <ion-label position="stacked"
                      >DeFi Protocol ID</ion-label
                    >
                    <ion-input
                      formControlName="displayName"
                    ></ion-input>
                  </ion-item>
                </ion-list>
              </ion-col>
            </ion-row>
          </ion-grid>
        </form>
      </ion-content>
      <ion-footer>
        <ion-button
          expand="full"
          type="submit"
          [disabled]="!txForm.valid"
          (click)="addTx($any($event.target));openAddTx = false;"
          >Submit
          {{
            ((txForm.value.price ?? 0) * (txForm.value.quantity ?? 0) +
              (txForm.value.fees ?? 0))
              | currency : "USD" : "symbol" : "1.2-2"
          }}</ion-button>

      </ion-footer>
    </ng-template>
  </ion-modal>
</ion-app>
